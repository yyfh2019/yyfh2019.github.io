<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script>
    (function() {
        // 增强版配置项
        const CONFIG = {
            source: 'https://yyfh.com',    // 源站域名
            pathDepth: 2,                  // 随机路径层级
            paramPattern: /^[a-z0-9-]{8,12}$/i // 路径参数格式验证
        };

        // 智能路径解析器
        function parseProxyPath() {
            const pathParts = window.location.pathname
                .split('/')
                .filter(p => p && p !== 'index.html');

            if (pathParts.length < CONFIG.pathDepth) {
                throw new Error('INVALID_PATH_DEPTH');
            }

            // 提取随机参数并验证
            const randParams = pathParts.slice(0, CONFIG.pathDepth);
            if (!randParams.every(p => CONFIG.paramPattern.test(p))) {
                throw new Error('INVALID_PARAM_FORMAT');
            }

            // 构造源站路径
            const sourcePath = '/' + pathParts.slice(CONFIG.pathDepth).join('/');
            
            return {
                proxyPrefix: '/' + randParams.join('/'),
                sourceUrl: new URL(
                    sourcePath + location.search + location.hash,
                    CONFIG.source
                )
            };
        }

        // 内容加载器
        async function loadContent() {
            try {
                const { proxyPrefix, sourceUrl } = parseProxyPath();
                
                // 发起智能请求
                const response = await fetch(sourceUrl.href, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include',
                    headers: {
                        'Accept': 'text/html',
                        'X-Proxy-Source': window.location.origin
                    }
                });

                if (!response.ok) throw new Error(`HTTP_${response.status}`);
                
                // 动态注入内容
                const html = await response.text();
                document.open();
                document.write(html
                    .replace(/<head>/i, `__CODE_BLOCK_0__<base href="${sourceUrl.origin}">`)
                    .replace(/<body>/i, '__CODE_BLOCK_0__<!--PROXY_LOADED-->')
                );
                document.close();

                // 高级链接重写
                rewriteAllLinks(proxyPrefix);
                initPerformanceMonitor();
            } catch (err) {
                handleError(err);
            }
        }

        // 链接重写引擎
        function rewriteAllLinks(prefix) {
            const elements = document.querySelectorAll([
                'a[href]',
                'link[href]',
                'img[src]',
                'script[src]'
            ].join(','));

            elements.forEach(el => {
                const attr = el.hasAttribute('href') ? 'href' : 'src';
                const url = new URL(el[attr], CONFIG.source);
                
                if (url.origin === CONFIG.source) {
                    el[attr] = location.origin + prefix + url.pathname;
                }
            });
        }

        // 错误处理器
        function handleError(err) {
            const messages = {
                'INVALID_PATH_DEPTH': '路径参数不足',
                'INVALID_PARAM_FORMAT': '参数格式错误',
                'HTTP_404': '内容不存在',
                'HTTP_500': '服务器错误'
            };
            
            document.body.innerHTML = `
                <div class="error-box">
                    <h2>🚨 加载失败</h2>
                    <p>错误类型：${messages[err.message] || err.message}</p>
                    <button onclick="location.reload()">点击重试</button>
                    <style>
                        .error-box {
                            padding: 2rem;
                            max-width: 600px;
                            margin: 2rem auto;
                            border: 1px solid #ff4444;
                            border-radius: 8px;
                            text-align: center;
                        }
                        button {
                            padding: 8px 20px;
                            background: #007bff;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        }
                    </style>
                </div>
            `;
        }

        // 性能监控（可选）
        function initPerformanceMonitor() {
            if (window.performance) {
                const timing = performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                console.log(`[Proxy Perf] 总加载时间: ${loadTime}ms`);
            }
        }

        // 启动加载流程
        loadContent();
    })();
    </script>
</head>
<body>
    <!-- 动态加载骨架屏 -->
    <div id="skeleton">
        <div class="skeleton-header"></div>
        <div class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>
        <style>
            #skeleton {
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
            }
            .skeleton-header {
                height: 40px;
                background: #f0f0f0;
                margin-bottom: 20px;
                border-radius: 4px;
            }
            .skeleton-line {
                height: 16px;
                background: #f0f0f0;
                margin-bottom: 12px;
                border-radius: 2px;
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
        </style>
    </div>
</body>
</html>
