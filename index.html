<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åŒæ¨¡çŸ­é“¾æœåŠ¡</title>
    <style>
        :root { --primary: #2196F3; --error: #f44336; }
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .container { background: #f8f9fa; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; }
        .input-group { display: flex; gap: 1rem; margin: 2rem 0; }
        input { flex: 1; padding: 0.8rem; border: 2px solid #ddd; border-radius: 5px; }
        button { background: var(--primary); color: white; border: none; padding: 0.8rem 2rem; border-radius: 5px; cursor: pointer; }
        .result { margin-top: 1rem; padding: 1rem; background: white; border-radius: 5px; }
        .error { color: var(--error); display: none; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— åŒæ¨¡çŸ­é“¾ç”Ÿæˆå™¨</h1>
        <div class="input-group">
            <input type="url" id="longUrl" placeholder="è¾“å…¥éœ€è¦ç¼©çŸ­çš„é•¿é“¾æ¥">
            <button onclick="generateFromUI()">ç”ŸæˆçŸ­é“¾</button>
        </div>
        <div class="error" id="errorMsg"></div>
        <div class="result" id="result"></div>
    </div>

    <script>
        // ç³»ç»Ÿé…ç½®
        const CONFIG = {
            TOKEN: 'cc77fb8efb04a0ba445772fa03083f16',
            TYPE: 'cyn',
            DOMAIN: 'https://yyfh2019.github.io',
            CODE_LENGTH: 6,
            STORAGE_KEY: 'url_mappings'
        };

        // åˆå§‹åŒ–å­˜å‚¨
        let urlMappings = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY)) || {};

        // è·¯ç”±å¤„ç†
        (function handleRouting() {
            const path = window.location.pathname.replace(/\//g, '');
            const params = new URLSearchParams(window.location.search);

            // æ¨¡å¼1ï¼š6ä½çŸ­ç è®¿é—®
            if (path.length === CONFIG.CODE_LENGTH) {
                const target = urlMappings[path];
                target ? window.location.replace(target) : showError('çŸ­é“¾æ¥ä¸å­˜åœ¨');
                return;
            }

            // æ¨¡å¼2ï¼šAPIæ¥å£è°ƒç”¨
            if (params.has('type') && params.has('token') && params.has('url')) {
                if (params.get('type') === CONFIG.TYPE && params.get('token') === CONFIG.TOKEN) {
                    const longUrl = decodeURIComponent(params.get('url'));
                    if (isValidUrl(longUrl)) {
                        const shortCode = generateShortCode(longUrl);
                        const shortUrl = `${CONFIG.DOMAIN}/${shortCode}`;
                        document.write(shortUrl); // ç›´æ¥è¿”å›ç”Ÿæˆçš„çŸ­é“¾
                        return;
                    }
                }
                showError('APIè°ƒç”¨å‚æ•°é”™è¯¯');
            }
        })();

        // ç”ŸæˆçŸ­ç ï¼ˆå‰ç«¯ç•Œé¢è°ƒç”¨ï¼‰
        function generateFromUI() {
            const longUrl = document.getElementById('longUrl').value.trim();
            
            if (!isValidUrl(longUrl)) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€');
                return;
            }

            const shortCode = generateShortCode(longUrl);
            const shortUrl = `${CONFIG.DOMAIN}/${shortCode}`;
            
            document.getElementById('result').innerHTML = `
                <p>ç”Ÿæˆçš„çŸ­é“¾æ¥ï¼š</p>
                <input value="${shortUrl}" readonly style="width:100%; padding:0.5rem; margin:0.5rem 0;">
                <button onclick="copyUrl('${shortUrl}')">å¤åˆ¶é“¾æ¥</button>
                <button onclick="window.open('${shortUrl}', '_blank')">æµ‹è¯•è®¿é—®</button>
            `;
        }

        // ç”ŸæˆéšæœºçŸ­ç 
        function generateShortCode(url) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let code = '';
            
            // ç”Ÿæˆå”¯ä¸€çŸ­ç 
            do {
                code = Array.from({length: CONFIG.CODE_LENGTH}, 
                    () => chars[Math.floor(Math.random() * chars.length)]).join('');
            } while (urlMappings[code]);

            // å­˜å‚¨æ˜ å°„å…³ç³»
            urlMappings[code] = url;
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(urlMappings));
            
            return code;
        }

        // å·¥å…·å‡½æ•°
        function isValidUrl(url) {
            try {
                new URL(url);
                return /^https?:/.test(url);
            } catch {
                return false;
            }
        }

        function showError(msg) {
            const el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url)
                .then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
                .catch(() => showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'));
        }
    </script>
</body>
</html>
