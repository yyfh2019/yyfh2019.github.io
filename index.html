<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script>
    (function() {
        // å¢å¼ºç‰ˆé…ç½®é¡¹
        const CONFIG = {
            source: 'https://yyfh.com',    // æºç«™åŸŸå
            pathDepth: 2,                  // éšæœºè·¯å¾„å±‚çº§
            paramPattern: /^[a-z0-9-]{8,12}$/i // è·¯å¾„å‚æ•°æ ¼å¼éªŒè¯
        };

        // æ™ºèƒ½è·¯å¾„è§£æå™¨
        function parseProxyPath() {
            const pathParts = window.location.pathname
                .split('/')
                .filter(p => p && p !== 'index.html');

            if (pathParts.length < CONFIG.pathDepth) {
                throw new Error('INVALID_PATH_DEPTH');
            }

            // æå–éšæœºå‚æ•°å¹¶éªŒè¯
            const randParams = pathParts.slice(0, CONFIG.pathDepth);
            if (!randParams.every(p => CONFIG.paramPattern.test(p))) {
                throw new Error('INVALID_PARAM_FORMAT');
            }

            // æ„é€ æºç«™è·¯å¾„
            const sourcePath = '/' + pathParts.slice(CONFIG.pathDepth).join('/');
            
            return {
                proxyPrefix: '/' + randParams.join('/'),
                sourceUrl: new URL(
                    sourcePath + location.search + location.hash,
                    CONFIG.source
                )
            };
        }

        // å†…å®¹åŠ è½½å™¨
        async function loadContent() {
            try {
                const { proxyPrefix, sourceUrl } = parseProxyPath();
                
                // å‘èµ·æ™ºèƒ½è¯·æ±‚
                const response = await fetch(sourceUrl.href, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include',
                    headers: {
                        'Accept': 'text/html',
                        'X-Proxy-Source': window.location.origin
                    }
                });

                if (!response.ok) throw new Error(`HTTP_${response.status}`);
                
                // åŠ¨æ€æ³¨å…¥å†…å®¹
                const html = await response.text();
                document.open();
                document.write(html
                    .replace(/<head>/i, `__CODE_BLOCK_0__<base href="${sourceUrl.origin}">`)
                    .replace(/<body>/i, '__CODE_BLOCK_0__<!--PROXY_LOADED-->')
                );
                document.close();

                // é«˜çº§é“¾æ¥é‡å†™
                rewriteAllLinks(proxyPrefix);
                initPerformanceMonitor();
            } catch (err) {
                handleError(err);
            }
        }

        // é“¾æ¥é‡å†™å¼•æ“
        function rewriteAllLinks(prefix) {
            const elements = document.querySelectorAll([
                'a[href]',
                'link[href]',
                'img[src]',
                'script[src]'
            ].join(','));

            elements.forEach(el => {
                const attr = el.hasAttribute('href') ? 'href' : 'src';
                const url = new URL(el[attr], CONFIG.source);
                
                if (url.origin === CONFIG.source) {
                    el[attr] = location.origin + prefix + url.pathname;
                }
            });
        }

        // é”™è¯¯å¤„ç†å™¨
        function handleError(err) {
            const messages = {
                'INVALID_PATH_DEPTH': 'è·¯å¾„å‚æ•°ä¸è¶³',
                'INVALID_PARAM_FORMAT': 'å‚æ•°æ ¼å¼é”™è¯¯',
                'HTTP_404': 'å†…å®¹ä¸å­˜åœ¨',
                'HTTP_500': 'æœåŠ¡å™¨é”™è¯¯'
            };
            
            document.body.innerHTML = `
                <div class="error-box">
                    <h2>ğŸš¨ åŠ è½½å¤±è´¥</h2>
                    <p>é”™è¯¯ç±»å‹ï¼š${messages[err.message] || err.message}</p>
                    <button onclick="location.reload()">ç‚¹å‡»é‡è¯•</button>
                    <style>
                        .error-box {
                            padding: 2rem;
                            max-width: 600px;
                            margin: 2rem auto;
                            border: 1px solid #ff4444;
                            border-radius: 8px;
                            text-align: center;
                        }
                        button {
                            padding: 8px 20px;
                            background: #007bff;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                        }
                    </style>
                </div>
            `;
        }

        // æ€§èƒ½ç›‘æ§ï¼ˆå¯é€‰ï¼‰
        function initPerformanceMonitor() {
            if (window.performance) {
                const timing = performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                console.log(`[Proxy Perf] æ€»åŠ è½½æ—¶é—´: ${loadTime}ms`);
            }
        }

        // å¯åŠ¨åŠ è½½æµç¨‹
        loadContent();
    })();
    </script>
</head>
<body>
    <!-- åŠ¨æ€åŠ è½½éª¨æ¶å± -->
    <div id="skeleton">
        <div class="skeleton-header"></div>
        <div class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
        </div>
        <style>
            #skeleton {
                padding: 20px;
                max-width: 800px;
                margin: 0 auto;
            }
            .skeleton-header {
                height: 40px;
                background: #f0f0f0;
                margin-bottom: 20px;
                border-radius: 4px;
            }
            .skeleton-line {
                height: 16px;
                background: #f0f0f0;
                margin-bottom: 12px;
                border-radius: 2px;
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
        </style>
    </div>
</body>
</html>
